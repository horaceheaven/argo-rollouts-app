apiVersion: v1
kind: Namespace
metadata:
  name: nginx-demo
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-blue
  namespace: nginx-demo
data:
  index.html: "<!DOCTYPE html>\n<html>\n<head>\n    <title>Production - Nginx Demo</title>\n\
    \    <style>\n        body {\n            margin: 0;\n            padding: 0;\n\
    \            display: flex;\n            justify-content: center;\n          \
    \  align-items: center;\n            min-height: 100vh;\n            background:\
    \ linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            font-family:\
    \ 'Arial', sans-serif;\n        }\n        .container {\n            text-align:\
    \ center;\n            color: white;\n            padding: 50px;\n           \
    \ background: rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n  \
    \          backdrop-filter: blur(10px);\n            box-shadow: 0 8px 32px 0\
    \ rgba(31, 38, 135, 0.37);\n        }\n        h1 {\n            font-size: 72px;\n\
    \            margin: 20px 0;\n            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n\
    \        }\n        .version {\n            font-size: 36px;\n            margin:\
    \ 20px 0;\n            padding: 20px 40px;\n            background: rgba(255,\
    \ 255, 255, 0.2);\n            border-radius: 10px;\n        }\n        .info\
    \ {\n            font-size: 18px;\n            margin-top: 30px;\n           \
    \ opacity: 0.9;\n        }\n        .badge {\n            display: inline-block;\n\
    \            padding: 10px 20px;\n            background: #4299e1;\n         \
    \   border-radius: 20px;\n            margin: 10px;\n            font-weight:\
    \ bold;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\"\
    >\n        <div class=\"status-banner\">\U0001F535 PRODUCTION ENVIRONMENT</div>\n\
    \        <h1>BLUE VERSION</h1>\n        <div class=\"version\">Version 1.0</div>\n\
    \        <div class=\"info\">\n            <div class=\"badge\">Production Ready</div>\n\
    \            <div class=\"badge\">Stable</div>\n            <div class=\"badge\"\
    >Active</div>\n        </div>\n        <p style=\"margin-top: 40px; font-size:\
    \ 20px;\">\n            This is the <strong>BLUE</strong> environment<br>\n  \
    \          Currently serving all production traffic<br>\n            <span style=\"\
    font-size: 16px; opacity: 0.8;\">Active Service: nginx-demo</span>\n        </p>\n\
    \        <div style=\"margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.2);\
    \ border-radius: 10px; font-family: monospace;\">\n            <div style=\"font-size:\
    \ 14px; opacity: 0.9; margin-bottom: 5px;\">Git Commit:</div>\n            \x01\
    b551c4dfa7f61f7873883e1397804373b65f0b75\x03\n        </div>\n    </div>\n</body>\n\
    </html>\n"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-green
  namespace: nginx-demo
data:
  index.html: "<!DOCTYPE html>\n<html>\n<head>\n    <title>Preview - Nginx Demo</title>\n\
    \    <style>\n        body {\n            margin: 0;\n            padding: 0;\n\
    \            display: flex;\n            justify-content: center;\n          \
    \  align-items: center;\n            min-height: 100vh;\n            background:\
    \ linear-gradient(135deg, #11998e 0%, #38ef7d 100%);\n            font-family:\
    \ 'Arial', sans-serif;\n        }\n        .container {\n            text-align:\
    \ center;\n            color: white;\n            padding: 50px;\n           \
    \ background: rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n  \
    \          backdrop-filter: blur(10px);\n            box-shadow: 0 8px 32px 0\
    \ rgba(31, 38, 135, 0.37);\n        }\n        h1 {\n            font-size: 72px;\n\
    \            margin: 20px 0;\n            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n\
    \        }\n        .version {\n            font-size: 36px;\n            margin:\
    \ 20px 0;\n            padding: 20px 40px;\n            background: rgba(255,\
    \ 255, 255, 0.2);\n            border-radius: 10px;\n        }\n        .info\
    \ {\n            font-size: 18px;\n            margin-top: 30px;\n           \
    \ opacity: 0.9;\n        }\n        .badge {\n            display: inline-block;\n\
    \            padding: 10px 20px;\n            background: #48bb78;\n         \
    \   border-radius: 20px;\n            margin: 10px;\n            font-weight:\
    \ bold;\n        }\n        .status-banner {\n            font-size: 24px;\n \
    \           font-weight: bold;\n            padding: 15px 30px;\n            background:\
    \ rgba(255, 255, 255, 0.3);\n            border-radius: 15px;\n            margin-bottom:\
    \ 20px;\n            border: 3px solid #fff;\n            animation: pulse 2s\
    \ infinite;\n        }\n        @keyframes pulse {\n            0%, 100% { transform:\
    \ scale(1); }\n            50% { transform: scale(1.05); }\n        }\n    </style>\n\
    </head>\n<body>\n    <div class=\"container\">\n        <div class=\"status-banner\"\
    >\U0001F7E2 PREVIEW ENVIRONMENT</div>\n        <h1>GREEN VERSION</h1>\n      \
    \  <div class=\"version\" >Version 2.0</div>\n        <div class=\"info\">\n \
    \           <div class=\"badge\" >New Features</div>\n            <div class=\"\
    badge\">Enhanced</div>\n            <div class=\"badge\">Preview Mode</div>\n\
    \            <div class=\"badge\">Awaiting Promotion</div>\n        </div>\n \
    \       <p style=\"margin-top: 40px; font-size: 20px;\">\n            This is\
    \ the <strong>PREVIEW</strong> environment<br>\n            Testing new version\
    \ before promotion to production<br>\n            <span style=\"font-size: 16px;\
    \ opacity: 0.8;\">Preview Service: nginx-demo-preview</span><br>\n           \
    \ <span style=\"font-size: 14px; opacity: 0.7; margin-top: 10px; display: block;\"\
    >Ready for manual promotion to production \U0001F680</span>\n        </p>\n  \
    \      <div style=\"margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.2);\
    \ border-radius: 10px; font-family: monospace;\">\n            <div style=\"font-size:\
    \ 14px; opacity: 0.9; margin-bottom: 5px;\">Git Commit:</div>\n            \x01\
    b551c4dfa7f61f7873883e1397804373b65f0b75\x03\n        </div>\n    </div>\n</body>\n\
    </html>\n"
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-demo
  namespace: nginx-demo
spec:
  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  selector:
    app: nginx-demo
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-demo-preview
  namespace: nginx-demo
spec:
  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  selector:
    app: nginx-demo
---
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: nginx-demo
  namespace: nginx-demo
spec:
  replicas: 1
  revisionHistoryLimit: 3
  progressDeadlineSeconds: 300
  selector:
    matchLabels:
      app: nginx-demo
  template:
    metadata:
      labels:
        app: nginx-demo
        version: blue
    spec:
      containers:
      - name: nginx
        image: 416716292256.dkr.ecr.us-west-2.amazonaws.com/nginx-demo-app:cae4c3506fe5f91383839a14889a42f7c8e6f337
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
        resources:
          limits:
            cpu: 50m
            memory: 64Mi
          requests:
            cpu: 25m
            memory: 32Mi
      volumes:
      - name: html
        configMap:
          name: nginx-blue
  strategy:
    blueGreen:
      activeService: nginx-demo
      previewService: nginx-demo-preview
      autoPromotionEnabled: false
      autoPromotionSeconds: 30
      scaleDownDelaySeconds: 30
      prePromotionAnalysis:
        templates:
        - templateName: nginx-simple-health-check
      postPromotionAnalysis:
        templates:
        - templateName: nginx-post-promotion-check
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-demo
  namespace: nginx-demo
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/success-codes: '200'
spec:
  ingressClassName: alb
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-demo
            port:
              name: http
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-demo-preview
  namespace: nginx-demo
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/success-codes: '200'
spec:
  ingressClassName: alb
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-demo-preview
            port:
              name: http
