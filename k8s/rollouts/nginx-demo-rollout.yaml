apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: nginx-demo
  namespace: nginx-demo
spec:
  replicas: 1
  revisionHistoryLimit: 3
  progressDeadlineSeconds: 300 # Rollback if rollout doesn't progress within 5 minutes
  selector:
    matchLabels:
      app: nginx-demo
  template:
    metadata:
      labels:
        app: nginx-demo
        version: blue # This will change to 'green' when we update
    spec:
      containers:
        - name: nginx
          image: 416716292256.dkr.ecr.us-west-2.amazonaws.com/nginx-demo-app:fde58da7f91e144eb3a317c67bf18f5ef3151951
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          # Health checks for automatic rollback on pod failures
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3 # Restart pod after 3 failures
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3 # Mark pod as not ready after 3 failures
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html
          resources:
            limits:
              cpu: 50m
              memory: 64Mi
            requests:
              cpu: 25m
              memory: 32Mi
      volumes:
        - name: html
          configMap:
            name: nginx-blue # Start with Blue version
  strategy:
    blueGreen:
      activeService: nginx-demo
      previewService: nginx-demo-preview
      autoPromotionEnabled: false
      autoPromotionSeconds: 30
      scaleDownDelaySeconds: 30
      # Pre-promotion analysis: Validate green before promoting
      # This runs health checks on the preview (green) service before allowing promotion
      prePromotionAnalysis:
        templates:
          - templateName: nginx-simple-health-check
        # Run analysis for up to 5 minutes before promotion
        startingDeadlineSeconds: 300
      # Post-promotion analysis: Monitor after promotion and rollback if issues
      # This continues monitoring the active service after promotion and rolls back if health degrades
      postPromotionAnalysis:
        templates:
          - templateName: nginx-post-promotion-check
        # Monitor for 5 minutes after promotion
        startingDeadlineSeconds: 300
