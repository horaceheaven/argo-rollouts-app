---
apiVersion: v1
kind: Namespace
metadata:
  name: nginx-demo
---
# Blue Version ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-blue
  namespace: nginx-demo
data:
  index.html: "<!DOCTYPE html>\n<html>\n<head>\n    <title>Blue Version v1</title>\n    <style>\n        body {\n            margin: 0;\n            padding: 0;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            min-height: 100vh;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            font-family: 'Arial', sans-serif;\n        }\n        .container {\n            text-align: center;\n            color: white;\n            padding: 50px;\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);\n        }\n        h1 {\n            font-size: 72px;\n            margin: 20px 0;\n            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n        }\n        .version {\n            font-size: 36px;\n            margin: 20px 0;\n            padding: 20px 40px;\n            background: rgba(255, 255, 255, 0.2);\n            border-radius: 10px;\n        }\n        .info {\n            font-size: 18px;\n            margin-top: 30px;\n            opacity: 0.9;\n        }\n        .badge {\n            display: inline-block;\n            padding: 10px 20px;\n            background: #4299e1;\n            border-radius: 20px;\n            margin: 10px;\n            font-weight: bold;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>\U0001F535 BLUE VERSION v1</h1>\n        <div class=\"version\">Version 1.0</div>\n        <div class=\"info\">\n            <div class=\"badge\">Production Ready</div>\n            <div class=\"badge\">Stable</div>\n            <div class=\"badge\">Active</div>\n        </div>\n        <p style=\"margin-top: 40px; font-size: 20px;\">\n            This is the <strong>BLUE</strong> environment<br>\n            Currently serving production traffic\n        </p>\n    </div>\n</body>\n</html>\n"
---
# Green Version ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-green
  namespace: nginx-demo
data:
  index.html: "<!DOCTYPE html>\n<html>\n<head>\n    <title>Green Version</title>\n    <style>\n        body {\n            margin: 0;\n            padding: 0;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            min-height: 100vh;\n            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);\n            font-family: 'Arial', sans-serif;\n        }\n        .container {\n            text-align: center;\n            color: white;\n            padding: 50px;\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);\n        }\n        h1 {\n            font-size: 72px;\n            margin: 20px 0;\n            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);\n        }\n        .version {\n            font-size: 36px;\n            margin: 20px 0;\n            padding: 20px 40px;\n            background: rgba(255, 255, 255, 0.2);\n            border-radius: 10px;\n        }\n        .info {\n            font-size: 18px;\n            margin-top: 30px;\n            opacity: 0.9;\n        }\n        .badge {\n            display: inline-block;\n            padding: 10px 20px;\n            background: #48bb78;\n            border-radius: 20px;\n            margin: 10px;\n            font-weight: bold;\n        }\n        .new {\n            animation: pulse 2s infinite;\n        }\n        @keyframes pulse {\n            0%, 100% { transform: scale(1); }\n            50% { transform: scale(1.05); }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1 class=\"new\">\U0001F7E2 GREEN VERSION</h1>\n        <div class=\"version\">Version 2.0</div>\n        <div class=\"info\">\n            <div class=\"badge\">New Features</div>\n            <div class=\"badge\">Enhanced</div>\n            <div class=\"badge\">Preview</div>\n        </div>\n        <p style=\"margin-top: 40px; font-size: 20px;\">\n            This is the <strong>GREEN</strong> environment<br>\n            New version ready for promotion! \U0001F680\n        </p>\n    </div>\n</body>\n</html>\n"
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-demo
  namespace: nginx-demo
spec:
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
  selector:
    app: nginx-demo
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-demo-preview
  namespace: nginx-demo
spec:
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
  selector:
    app: nginx-demo
---
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: nginx-demo
  namespace: nginx-demo
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: nginx-demo
  template:
    metadata:
      labels:
        app: nginx-demo
        version: blue # This will change to 'green' when we update
    spec:
      containers:
        - name: nginx
          image: 416716292256.dkr.ecr.us-west-2.amazonaws.com/nginx-demo-app:154f5ebfdafa6dcd051999c8cd9008090937d7b8
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          volumeMounts:
            - name: html
              mountPath: /usr/share/nginx/html
          resources:
            limits:
              cpu: 50m
              memory: 64Mi
            requests:
              cpu: 25m
              memory: 32Mi
      volumes:
        - name: html
          configMap:
            name: nginx-blue # Start with Blue version
  strategy:
    blueGreen:
      activeService: nginx-demo
      previewService: nginx-demo-preview
      autoPromotionEnabled: false
      autoPromotionSeconds: 30
      scaleDownDelaySeconds: 30
