---
# Simple HTTP-based AnalysisTemplate (recommended for your setup)
# This uses a Job-based approach to check HTTP endpoints
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: nginx-simple-health-check
  namespace: nginx-demo
spec:
  metrics:
    # HTTP availability check using a simple script
    - name: http-success-rate
      interval: 30s
      count: 2  # Run 2 checks over 1 minute
      successCondition: result[0] >= 0.8  # 80% success rate required
      failureLimit: 2  # Rollback after 2 consecutive failures
      provider:
        job:
          spec:
            template:
              spec:
                containers:
                  - name: http-check
                    image: curlimages/curl:latest
                    command:
                      - sh
                      - -c
                      - |
                        # Check if the service is responding
                        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://nginx-demo-preview.nginx-demo.svc.cluster.local/ || echo "000")
                        if [ "$HTTP_CODE" = "200" ]; then
                          echo "1"
                        else
                          echo "0"
                        fi
                restartPolicy: Never
---
# AnalysisTemplate for post-promotion monitoring
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: nginx-post-promotion-check
  namespace: nginx-demo
spec:
  metrics:
    # Monitor active service after promotion
    - name: post-promotion-health
      interval: 30s
      count: 2  # Monitor for 1 minute after promotion
      successCondition: result[0] >= 0.9  # 90% success rate required
      failureLimit: 2  # Rollback if 2 consecutive failures
      provider:
        job:
          spec:
            template:
              spec:
                containers:
                  - name: http-check
                    image: curlimages/curl:latest
                    command:
                      - sh
                      - -c
                      - |
                        # Check if the active service is responding
                        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://nginx-demo.nginx-demo.svc.cluster.local/ || echo "000")
                        if [ "$HTTP_CODE" = "200" ]; then
                          echo "1"
                        else
                          echo "0"
                        fi
                restartPolicy: Never

